name: Run Mini Experiment Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  experiment:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Check Python syntax
      run: |
        python -m compileall scripts/ -q
    
    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Start Docker services
      run: |
        docker compose up -d
        sleep 30  # Wait for services to be healthy
    
    - name: Check service health
      run: |
        docker compose ps
        # Wait for all services to be healthy
        timeout 120 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 5; done' || true
        # Verify API v1 is responding
        curl -f http://localhost:8001/checkout -X POST -H "Content-Type: application/json" -d '{"user_id":"healthcheck","amount":"1.00"}' || echo "Health check endpoint may not exist, continuing..."
    
    - name: Run mini experiment suite (N=3, reduced duration)
      run: |
        # Set reduced test duration for CI (modify k6 scripts or use env vars)
        export K6_DURATION=300  # 5 minutes instead of 10
        python scripts/run_experiment_suite.py --scenario canary --n-runs 3 --base-seed 42 --output-dir results/ci/canary --python-cmd python
        python scripts/run_experiment_suite.py --scenario bluegreen --n-runs 3 --base-seed 42 --output-dir results/ci/bluegreen --python-cmd python
      continue-on-error: true  # Don't fail if experiments have issues
    
    - name: Aggregate results
      run: |
        python scripts/statistical_analysis.py --runs-dir results/ci/canary --scenario canary --output results/ci/aggregated_results.json
        python scripts/statistical_analysis.py --runs-dir results/ci/bluegreen --scenario bluegreen --output results/ci/aggregated_results.json
      continue-on-error: true
    
    - name: Generate summary report
      run: |
        python scripts/generate_summary.py --aggregated-results results/ci/aggregated_results.json --output results/ci/summary.md
      continue-on-error: true
    
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: experiment-results
        path: |
          results/ci/**/*.json
          results/ci/**/*.md
          results/ci/**/*.png
          results/ci/**/*.csv
        retention-days: 7
    
    - name: Cleanup
      if: always()
      run: |
        docker compose down -v
